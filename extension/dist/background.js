import{S as l}from"./assets/constants.js";const h={tasks:[],blockedSites:[],activeSession:null,notes:""};function r(e){const s=[];return e.forEach((n,a)=>{s.push({...n,isBreak:!1}),a<e.length-1&&s.push({id:`${n.id}-break-${a}`,title:"Recharge break",estimatedMinutes:5,order:n.order+.5,isBreak:!0})}),s}function u(e){const s=r(e);if(!s.length)return[];const n=[];let a=Date.now();return s.forEach(t=>{const i=t.estimatedMinutes*6e4;n.push({id:t.id,title:t.isBreak?`${t.title} (5 min)`:t.title,startTime:a,endTime:a+i,isBreak:t.isBreak,durationMinutes:t.estimatedMinutes}),a+=i}),n}function b(e,s){const n=r(e),a=u(e),t=Date.now();return{baseTasks:e,entries:n,blockedSites:s,currentIndex:0,phaseStartedAt:t,sessionStartedAt:t,timetable:a}}function y(e){return e.map((s,n)=>({...s,order:n}))}const d=1e3;async function f(){return(await chrome.storage.local.get([l]))[l]??{...h}}async function c(e){await chrome.storage.local.set({[l]:e})}async function S(e){const s=e.map(a=>a.replace(/^https?:\/\//,"").replace(/\/$/,"").split("/")[0]).filter(Boolean),n=s.map((a,t)=>({id:d+t,priority:1,action:{type:"redirect",redirect:{extensionPath:"/content_block_page.html"}},condition:{urlFilter:`||${a}^`,resourceTypes:["main_frame"]}}));await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:Array.from({length:s.length+5},(a,t)=>d+t),addRules:n})}async function T(){await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:Array.from({length:500},(e,s)=>d+s),addRules:[]})}function p(e=""){return{id:crypto.randomUUID(),title:e,estimatedMinutes:25,order:Date.now()}}async function w(e){const s=await f(),n=e.type;switch(n==="START_FOCUS_SESSION"?(e.type="SF_START_SESSION",e.payload?.baseTasks&&(e.payload={tasks:e.payload.baseTasks,blockedSites:e.payload.blockedSites||[]})):n==="END_FOCUS_SESSION"?e.type="SF_END_SESSION":n==="NEXT_PHASE"?e.type="SF_NEXT_PHASE":n==="UPDATE_FOCUS_SESSION"&&(e.type="SF_UPDATE_SESSION"),e.type){case"SF_PING":return{success:!0,payload:null};case"SF_GET_STATE":return{success:!0,payload:s};case"SF_SET_PLAN":{const{tasks:a=[],blockedSites:t=[]}=e.payload??{},i=y(a),o={...s,tasks:i.length?i:[p("New task")],blockedSites:t};return o.activeSession&&(o.activeSession.entries=r(o.tasks),o.activeSession.timetable=u(o.tasks),o.activeSession.blockedSites=t),await c(o),o.activeSession&&await S(t),{success:!0,payload:o}}case"SF_UPDATE_NOTES":{const{notes:a=""}=e.payload??{},t={...s,notes:a};return await c(t),{success:!0,payload:t}}case"SF_START_SESSION":{let a=s.tasks.length?s.tasks:[p("New task")],t=s.blockedSites.length?s.blockedSites:["youtube.com"];e.payload?.baseTasks?(a=e.payload.baseTasks,t=e.payload.blockedSites||t):e.payload?.tasks&&(a=e.payload.tasks,t=e.payload.blockedSites||t);const i=b(a,t),o={...s,tasks:a,blockedSites:t,activeSession:i};return await S(t),await c(o),{success:!0,payload:o,session:i}}case"SF_END_SESSION":{const a={...s,activeSession:null};return await T(),await c(a),{success:!0,payload:a}}case"SF_NEXT_PHASE":{if(!s.activeSession)return{success:!1,error:"No active session"};const a=e.payload?.currentIndex??s.activeSession.currentIndex+1;if(a>=s.activeSession.entries.length){const o={...s,activeSession:null};return await T(),await c(o),{success:!0,payload:o}}const t={...s.activeSession,currentIndex:a,phaseStartedAt:Date.now()},i={...s,activeSession:t};return await c(i),{success:!0,payload:i,session:t}}case"SF_UPDATE_SESSION":{if(!s.activeSession)return{success:!1,error:"No active session"};const a=e.payload??{};let t=s.activeSession.baseTasks,i=s.activeSession.blockedSites;a.baseTasks&&(t=y(a.baseTasks)),a.blockedSites&&(i=a.blockedSites);const o=r(t),E=u(t),k={...s.activeSession,baseTasks:t,entries:o,timetable:E,blockedSites:i},_={...s,activeSession:k,tasks:t,blockedSites:i};return await S(i),await c(_),{success:!0,payload:_,session:k}}default:return{success:!1,error:`Unknown request: ${e.type}`}}}chrome.runtime.onMessage.addListener((e,s,n)=>{const a=e?.type?.startsWith("SF_"),t=["START_FOCUS_SESSION","END_FOCUS_SESSION","NEXT_PHASE","UPDATE_FOCUS_SESSION"].includes(e?.type);return!a&&!t?!1:(w(e).then(i=>{n({requestId:e.requestId,...i})}).catch(i=>{n({requestId:e.requestId,success:!1,error:i.message??"Unexpected error"})}),!0)});chrome.runtime.onInstalled.addListener(async()=>{const e=await f();e.tasks.length||await c({...e,tasks:[p("Homework session")]})});
